% Materials and methods chapter

\chapter{Methods and materials}
\label{materials-methods}
This chapter describes in the first section how robot was configured, the preliminary analyzes on the robot and how the experiment is conducted. In the second section is described how I prepare the experiment and materials used for tests.

%----------------------------------------------------------------------------------------
\section{About the robot}
\label{about-the-robot}
The \kuka{} is a robot with collaborative features. It has a 14 kg payload and it has an action range from $ 800mm $ to $ 820 mm $. It is one of the latest robotic innovation, with the ability to work with humans. It has built in sensors and soft edges that make it safe for human collaboration and the ability to detect movement and touch all over. Moreover it has a media flange, with an internal wiring that is helpful to attach a lot of tools. When a tool is attached it's considered in the kinematic chain. In our case the tool selected is a \textit{Gimatic MPLM3240} that is a electric parallel gripper with 2 self-centering two jaw. It has a total gripping force of $ 210 N $.

\begin{figure}[H]
	\centering
	\includegraphics{kuka_lbr_iiwa.png}
	\caption{The \kuka{}}
\end{figure}


\section{Methods}
\label{methods}
The first thing that was done was the calibration of the gripper using the application provided by \textit{Kuka} and usable from the \textit{SmartPad}. This application consists of move the sixth and seventh link with multiple movements and provide a way to calculate the weight, center of mass and inertia matrix of the tool attached on media flange. This operations was made in the most used robot configurations and more times and returns reasonable results. Finally, the name of the tool shown at the end of the application was loaded from the running application as \texttt{ros\_param}.

Using \textit{ROS} and the open source stack available on \cite{iiwa-stack-link}, many \texttt{topics} can be used to calculate joint position and velocity, torque on joint, cartesian pose, force on referenced frame. Before the user study some data are collected to understand how the final experiment can be evaluated.

The topic called \texttt{CartesianWrench}, will show the external force measured bu the robot according to the used reference frame. In our case, the force is measured on the media flange. To understand if we could could consider the force applied on the EE, some experiments were conducted to understand the reliability and responsiveness of the values returned from this topic. This test were conducted using objects of different weight calibrated on a scale with precision to the gram and attached to both of the two jaws on the gripper. Every weighing was performed in two different configuration of the robot and for two times. In table \ref{tab:wrench} the results obtained from the experiment.

\begin{table}[H]
	\centering
	\begin{tabular}{l||llllll}
		&\textbf{400 gr}	&\textbf{700 gr}	&\textbf{1000 gr}	&\textbf{1300 gr} &\textbf{1600 gr}\\

		\hline\hline

		\textbf{Home pose}	&4,777		&7,566		&10,129		&13,302		&15,926	\\
		\textbf{Home pose}	&4,702		&7,531		&10,145		&13,332		&16,083	\\
		\textbf{On pallet} 	&4,475		&7,267		&9,541		&13,696		&16,253	\\
		\textbf{On pallet} 	&4,477		&7,245		&12,139		&13,641		&16,208	\\
		\textbf{On buffer} 	&2,349		&6,581		&9,626		&12,254		&15,385	\\
		\textbf{On buffer} 	&2,895		&6,615		&9,718		&12,330		&16,244 \\
		
		\hline \hline
		
		\textbf{Mean}			&3,946		&7,134		&10,216		&13,093		&16,017	\\
		\textbf{Std deviation}	&1,046		&0,435		&0,975		&0,640		&0,333	
	\end{tabular}
	\caption{Results from experiment to evaluate force on EE}
	\label{tab:wrench}
\end{table}
From the test we can understand that the values obtained are reasonable and in line with expectations, even if in the case of robots with elbow in high position (on pallet) the values are underestimated. This test was done in position and impedance control and the results are similar.

Another test that was made using the force applied on EE analyzes the maximum force that can be applied by the robot on a linear surface before that the collision avoidance feature is activated. This test also helped us to understand the reliability of the read values. It was made using position control in figure \ref{fig:wrench_position} and impedance control in \ref{fig:wrench_impedance}.

\begin{figure}[ht]
	\centering
	\includegraphics[scale=0.5]{position_wrench.png}
	\caption{Force calculated on EE in position control}
	\label{fig:wrench_position}
\end{figure}

\begin{figure}[ht]
	\centering
	\includegraphics[scale=0.5]{impedance_wrench.png}
	\caption{Force calculated on EE in impedance control}
	\label{fig:wrench_impedance}
\end{figure} 
In figure \ref{fig:wrench_position} we can observe that using position control the curve of the force applied is exponential and it stops about a $ 14 N$ that is the maximum force that the \kuka{} can impart. Instead, in figure \ref{fig:wrench_impedance} we can immediately spot the difference between impedance and position control. We can see that the maximum force that can be applied before that collision avoidance is activated is no longer $ 14N $ but $ 7N $. This is due to impedance control that is an approach to dynamic control relating force and position. A \textit{spring constant} defines the force output for a compression of the spring, instead a \textit{damping constant} defines the force output for a velocity input. Using impedance control we are controlling the force of resistance to external motions that are imposed by the environment. In fact, in figure \ref{fig:wrench_impedance} we can see the behavior of the spring: it reacts to the force applied on the surface by adapting (the first part of the curve), but when the force is too much and the damping constant too low to perform an adaptive movement it stops and the robot applies the maximum possible force. Since there is the damping constant, the maximum force will therefore be $ 7N$.

As preliminary action a test of the final experiment discussed in section \ref{experiment} has been done for test how the experiment can be done by the participants. Especially, during this test all the possible data were collected subscribing to \texttt{topic} as:
\begin{itemize}
	\item \texttt{CartesianPose}: position and orientation of EE,
	\item \texttt{CartesianWrench}: force applied on EE,
	\item \texttt{JointPositionVelocity}: position and velocity of all joints,
	\item \texttt{JointExternalTorque} and \texttt{JointTorque}: torque applied on joints.
\end{itemize}
This phase of the test was made by an inexperienced user who had to do the same task for five times. The task consist to move four Lego blocks from a pick position to a place position. This task was repeated for both the modalities: \kt{} and \te{}. % TODO foto del pallet 
The data collected before the final experiment provides a solid basis to be able to perform a preliminary analysis to understand how to perform the final experiment by collecting only the data necessary for the final evaluation.

\begin{figure}[H]
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{kt_user.png}
		\caption{Test in \kt}
		\label{fig:kt_user}
	\end{subfigure}%
	\begin{subfigure}{.5\textwidth}%		
		\centering
		\includegraphics[width=1\linewidth]{kt_me.png}
		\caption{Test in \te}
		\label{fig:kt_me}	
	\end{subfigure}
	\caption{Difference between users in \kt}
	\label{fig:diff_teleop}
\end{figure}

\begin{figure}[H]
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{teleop_user.png}
		\caption{Test in \kt}
		\label{fig:teleop_user}
	\end{subfigure}%
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{teleop_me.png}
		\caption{Test in \te}
		\label{fig:teleop_me}
	\end{subfigure}
	\caption{Difference between users in \te}
	\label{fig:diff_kt}
\end{figure}
% dire che c'è differenza tra utente con e senza esperienza
% primo caso di esero
% plottare bene i tempi

%In our user study we collect all this data provided by the topics described at the beginning of this section.
% come viene misurato il tempo di contatto, wrench o durata? ...
% cosa viene registrato ...
% sample rate



\section{Materials} 
\label{materials}


% come sono stati creati i task --> tutto il background per creare l'esperimento
% descrizione del materiale utilizzato, lego e scatole per i test, cose cilindriche gripper funziona?
% poi è stato stampato il tutto, come sono stati creati i task ecc...
% task di siemens?

